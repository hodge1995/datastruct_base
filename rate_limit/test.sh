#!/bin/bash

echo "========================================="
echo "    é™æµç®—æ³•æµ‹è¯•è„šæœ¬"
echo "========================================="
echo ""

# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
echo "1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€..."
if ! curl -s http://localhost:8080/status > /dev/null 2>&1; then
    echo "âŒ æœåŠ¡å™¨æœªè¿è¡Œ! è¯·å…ˆå¯åŠ¨: go run main.go"
    exit 1
fi
echo "âœ… æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ"
echo ""

# æµ‹è¯•æ»‘åŠ¨çª—å£
echo "2. æµ‹è¯•æ»‘åŠ¨çª—å£é™æµ (å‘é€8ä¸ªè¯·æ±‚)..."
echo "-----------------------------------------"
for i in {1..8}; do
    echo "è¯·æ±‚ $i:"
    curl -s http://localhost:8080/sliding | jq -r '"  çŠ¶æ€: \(.status) | æ¶ˆæ¯: \(.message) | è®¡æ•°: \(.count)"' 2>/dev/null || \
    curl -s http://localhost:8080/sliding | grep -o '"status":"[^"]*"' | head -1
    sleep 0.3
done
echo ""

# ç­‰å¾…çª—å£æ»‘åŠ¨
echo "3. ç­‰å¾…çª—å£æ»‘åŠ¨ (ç­‰å¾…3ç§’)..."
sleep 3
echo ""

# æµ‹è¯•æ¼æ¡¶
echo "4. æµ‹è¯•æ¼æ¡¶é™æµ (å‘é€15ä¸ªè¯·æ±‚)..."
echo "-----------------------------------------"
for i in {1..15}; do
    echo "è¯·æ±‚ $i:"
    curl -s http://localhost:8080/leaky | jq -r '"  çŠ¶æ€: \(.status) | æ¶ˆæ¯: \(.message) | æ°´é‡: \(.water)"' 2>/dev/null || \
    curl -s http://localhost:8080/leaky | grep -o '"status":"[^"]*"' | head -1
    sleep 0.2
done
echo ""

# ç­‰å¾…æ¼æ¡¶å‡ºæ°´
echo "5. ç­‰å¾…æ¼æ¡¶å‡ºæ°´ (ç­‰å¾…5ç§’)..."
sleep 5
echo ""

# æŸ¥çœ‹æœ€ç»ˆçŠ¶æ€
echo "6. æŸ¥çœ‹æœ€ç»ˆçŠ¶æ€..."
echo "-----------------------------------------"
curl -s http://localhost:8080/status
echo ""

echo "========================================="
echo "æµ‹è¯•å®Œæˆ!"
echo "========================================="
echo ""
echo "ğŸ’¡ æç¤º:"
echo "   - æ»‘åŠ¨çª—å£: 10ç§’å†…æœ€å¤š5ä¸ªè¯·æ±‚"
echo "   - æ¼æ¡¶: å®¹é‡10ï¼Œé€Ÿç‡1è¯·æ±‚/ç§’"
echo "   - æ›´å¤šæµ‹è¯•: go run client.go"
